const ErrorHelper = require("../utils/error-helper");
const getRedisQueue = require("../services/redis-queue");
const appService = require("../services/application");

class AppController {
	static async submitApp(req, res) {
		try {
			if (!req.files || Object.keys(req.files).length === 0) {
				return res.status(400).send("No files were uploaded.");
			}
			const file = req.files.file;

			const filePath = `${__dirname}/temp/${file.name}`;
			
			file.mv(filePath, function(err) {
				if (err) {
					console.log(err)
					return res.status(500).send(err);
				}
			});

			const appId = await appService.submitApp("apk", filePath, file.name);
			console.log(appId)
			getRedisQueue().sendMessage(JSON.stringify({
				fileName: file.name,
				appId
			}));
			return res.status(200).send("success");
		} catch (err) {
			const appError = ErrorHelper.error(err);
			return res.status(appError.status).send(appError);
		}
	}
}

module.exports = AppController;
