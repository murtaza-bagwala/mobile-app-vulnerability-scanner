const request = require('./request-service');
const logger = require('../../config/winston-config');

const SCAN_API = 'https://www.immuniweb.com/mobile/api/upload';
const fs = require('fs');

exports.scanFile = async (filePath, filename) => {
  try {
    const formdata = {
      file: {
        value: fs.createReadStream(filePath),
        options: {
          filename,
        },
      },
    };
    const result = await request.post(SCAN_API, null, formdata);
    logger.info(`Received result ${result}`);
    if (!result) {
      logger.error(`Unable to submit app for scan ${filename}`);
    }
    fs.unlink(filePath, (err) => {
      if (err) {
        logger.error(`unable to remove file from the server ${err}`);
        return;
      }
      logger.info(`file removed successfully ${filePath}`);
    });
    return result[1].short_id;
  } catch (exception) {
    logger.error(`Error occured while calling a scanner ${exception}`);
    return null;
  }
};
