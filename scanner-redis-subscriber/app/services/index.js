
const RSMQWorker = require('rsmq-worker');
const dotenv = require('dotenv');
const logger = require('../../config/winston-config');
const { messageProcessor } = require('./message-processor');

const envFile = process.env.NODE_ENV ? `.env.${process.env.NODE_ENV}` : '.env';
dotenv.config({ path: envFile });

const worker = new RSMQWorker('app_events', {
  host: process.env.REDIS_HOST,
  port: process.env.REDIS_PORT,
  timeout: 0,
});

worker.on('message', async (event, next, id) => {
  console.log(event);
  const message = JSON.parse(event);
  logger.info(`Message ${message.fileName} received at : ${new Date().toISOString()}`);
  await messageProcessor(message.appId, message.fileName);
  next();
});

worker.on('error', (err, msg) => {
  logger.error('ERROR', err, msg.id);
});
worker.on('exceeded', (msg) => {
  logger.info(`EXCEEDED :: ${msg.id}`);
});
worker.on('timeout', (msg) => {
  logger.info(`TIMEOUT : ${msg} ::: ${msg.rc}`);
});

worker.start();
