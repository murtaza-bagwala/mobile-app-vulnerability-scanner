const azure = require('./azure/blob-container');
const getRedisService = require('./redis');
const logger = require('../../config/winston-config');
const appScanner = require('./app-scanner');

exports.messageProcessor = async (appId, fileName) => {
  try {
    const downloadedFilePath = await azure.downloadBlob(fileName);
    logger.info(downloadedFilePath)

    if (!downloadedFilePath) {
      logger.error(`Unable to download file from azure container service ${fileName}`);
      return false;
    }
    const scanId = await appScanner.scanFile(downloadedFilePath, fileName);
    if (!scanId) {
      logger.error(
        `Unable to upload file to security scanner ${fileName}`
      );
      return false;
    }
    logger.info(`storing scanId ${scanId} in redis agains appId ${appId}`)
    await getRedisService().setScanId(appId, scanId);
    return true;
  } catch (exception) {
    logger.error(
      `Error ${exception} occured while downloading file from from azure container service  ${fileName}`
    );
    return false;
  };
}