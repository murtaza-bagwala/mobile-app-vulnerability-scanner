const azure = require('./azure/blob-container');
const request = require('./request-service');
const getRedisService = require('./redis');
const logger = require('../../config/winston-config');
const appScanner = require('./app-scanner');

exports.messageProcessor = async (id, fileName) => {
  try {
    const downloadedFile = await azure.downloadBlob(fileName);
    console.log(downloadedFile)
    if (!downloadedFile) {
      logger.error(`Unable to download file from azure container service ${fileName}`);
      return false;
    }
    const scanId = await appScanner.scanFile(downloadedFile, fileName);
    if (!scanId) {
      logger.error(
        `Unable to upload file to security scanner ${fileName}`
      );
      return false;
    }
    await getRedisService().setScanId(id, scanId);
    return true;
  } catch (exception) {
    logger.error(
      `Error ${exception} occured while downloading file from from azure container service  ${fileName}`
    );
    return false;
  };
}